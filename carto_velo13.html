<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte avec Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="map" style="width: 100%; height: 600px;"></div>
  <div id="info-box"></div>
  <div class="selected-icons" id="selected-icons"></div>
  <div id="favorites-box" class="favorites-box">
    <img src="icons/favorite.png" alt="Favoris" class="favorite-icon">
    <span id="favorites-count">0</span>
    <button id="view-favorites" class="view-favorites-button">Voir les favoris</button>
    <img src="icons/trash.png" alt="Supprimer tous les favoris" class="trash-icon" id="trash-icon">
    <button id="travel-book" class="travel-book-button">Carnet de voyage</button>
  </div>

  <div id="travel-popup" class="travel-popup">
    <div class="travel-popup-content">
      <span id="close-travel-popup" class="close-popup">&times;</span>
      <h2>Carnet de voyage</h2>
      <div id="travel-content"></div>
      <div id="travel-map" style="width: 100%; height: 400px;"></div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Initialisation de la carte Leaflet
      var map = L.map('map').setView([43.492949, -1.474841], 13);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      var officesLayer = L.layerGroup().addTo(map);
      var bikeParkingLayer = L.layerGroup();
      var waterPointsLayer = L.layerGroup();
      var bikeRoutesLayer = L.layerGroup();
      var hotelsLayer = L.layerGroup();
      var campingCarLayer = L.layerGroup();
      var campingsLayer = L.layerGroup();
      var autreshebLayer = L.layerGroup();
      var currentGpxLayer = null;
      var currentMarker = null;

      // Icônes personnalisées
      var touristOfficeIcon = L.icon({ iconUrl: 'icons/tourist_office.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var bikeParkingIcon = L.icon({ iconUrl: 'icons/bicycle_parking.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var waterPointIcon = L.icon({ iconUrl: 'icons/water_point.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var hotelIcon = L.icon({ iconUrl: 'icons/logo_acc_velo.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var campingCarIcon = L.icon({ iconUrl: 'icons/camping-car.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var campingIcon = L.icon({ iconUrl: 'icons/logo_acc_velo.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var autreshebIcon = L.icon({ iconUrl: 'icons/logo_acc_velo.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });
      var bikeIcon = L.icon({ iconUrl: 'icons/velo.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] });

      // Gestion du Carnet de voyage
      document.getElementById('travel-book').addEventListener('click', function () {
        var popup = document.getElementById('travel-popup');
        var travelContent = document.getElementById('travel-content');
        travelContent.innerHTML = '';

        favorites.forEach(function (item) {
          var info = document.createElement('div');
          info.innerHTML = `<strong>${item.popupContent}</strong>`;
          travelContent.appendChild(info);
        });

        popup.style.display = 'block';

        setTimeout(function () {
          var travelMap = L.map('travel-map').setView([43.492949, -1.474841], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(travelMap);

          var bounds = [];
          favorites.forEach(function (item) {
            var lat = Array.isArray(item.lat) ? item.lat[1] : item.lat;
            var lon = Array.isArray(item.lon) ? item.lon[0] : item.lon;
            var marker = L.marker([lat, lon], { icon: item.icon }).addTo(travelMap);
            bounds.push([lat, lon]);
          });

          if (bounds.length > 0) {
            travelMap.fitBounds(bounds);
          }
        }, 100);
      });

      document.getElementById('close-travel-popup').addEventListener('click', function () {
        var popup = document.getElementById('travel-popup');
        popup.style.display = 'none';
      });

      // Ajout d'un contrôle personnalisé
      var customControl = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function (map) {
          var container = L.DomUtil.create('div', 'leaflet-control-custom');
          var header = L.DomUtil.create('div', 'header', container);
          var logo = L.DomUtil.create('img', '', header);
          logo.src = 'icons/LOGO_VISIT64.png';
          var title = L.DomUtil.create('h2', '', header);
          title.innerHTML = 'Carte vélo 64';

          var buttonOffices = L.DomUtil.create('button', 'offices-button', container);
          buttonOffices.innerHTML = '<img src="icons/tourist_office.png" alt="Office de Tourisme" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;"> Offices de Tourisme';
          L.DomEvent.on(buttonOffices, 'click', function () {
            // Ajout d'une couche d'exemple
            console.log("Office de tourisme affiché");
          });

          var buttonBikeRoutes = L.DomUtil.create('button', 'parcours-button', container);
          buttonBikeRoutes.innerHTML = 'Parcours vélo';
          L.DomEvent.on(buttonBikeRoutes, 'click', function () {
            // Ajout d'une couche d'exemple
            console.log("Parcours vélo affiché");
          });

          return container;
        }
      });

      map.addControl(new customControl());

      // Gestion des favoris (pour montrer les favoris par ex.)
      var favorites = [];
      document.getElementById('view-favorites').addEventListener('click', function () {
        console.log("Afficher les favoris");
      });

    });
  </script>
</body>
</html>
