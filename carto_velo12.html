<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte vélo 64</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; }
        .leaflet-control-custom { background: white; padding: 10px; }
        .button-container { display: flex; flex-direction: column; }
        .submenu { display: none; }
        .cross { position: absolute; right: 0; top: 0; cursor: pointer; }
        #info-box { background: white; padding: 10px; position: absolute; z-index: 9999; display: none; }
        #selected-icons { position: absolute; top: 10px; right: 10px; }
        #favorites-counter { font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="info-box"></div>
<div id="selected-icons"></div>
<div>Favoris: <span id="favorites-counter">0</span></div>

<script>
var officesUrl = 'https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];area(id:3600007450)->.searchArea;nwr["information"="office"](area.searchArea);out geom;';
var bikeParkingUrl = 'data/bike_parking.geojson';
var waterPointsUrl = 'data/water_points.geojson';
var hotelsUrl = 'data/HOT.geojson';
var campingCarUrl = 'data/ACC.geojson';
var campingsUrl = 'data/HPA.geojson';
var autreshebUrl = 'data/AUTRESHEEB.geojson';
var kmlFiles = ['KMLVELO/Velodyssee-Bayonne-BTZ-14122015.kml','KMLVELO/la-velodyssee-de-biarritz-a-st-jean-de-luz-etape-n19.kml','KMLVELO/cyclokml-nive-et-ocean.kml','KMLVELO/la-v-81-de-biarritz-a-urt-etape-n1.kml'];
var BikeRoutesUrl = 'data/ITIVELO.geojson';

var favorites = new Set(); // Utiliser un Set pour stocker les favoris
var favoriteLayer = L.layerGroup().addTo(map); // Calque pour les favoris

function updateFavoritesCounter() {
    var counter = document.getElementById('favorites-counter');
    if (counter) {
        counter.innerText = favorites.size; // Mettre à jour le compteur
    }
}

function toggleFavorite(elementId, marker) {
    if (favorites.has(elementId)) {
        favorites.delete(elementId); // Retirer des favoris
        favoriteLayer.removeLayer(marker); // Retirer le marqueur des favoris
        return 'Ajouter aux favoris';
    } else {
        favorites.add(elementId); // Ajouter aux favoris
        favoriteLayer.addLayer(marker); // Ajouter le marqueur aux favoris
        return 'Retirer des favoris';
    }
}

var customControl = L.Control.extend({
    options: {
        position: 'topleft'
    },
    onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-control-custom');

        var header = L.DomUtil.create('div', 'header', container);
        var logo = L.DomUtil.create('img', '', header);
        logo.src = 'icons/LOGO_VISIT64.png';
        var title = L.DomUtil.create('h2', '', header);
        title.innerHTML = 'Carte vélo 64';

        var buttonContainer = L.DomUtil.create('div', 'button-container', container);

        var buttonOffices = L.DomUtil.create('button', 'offices-button', container);
        buttonOffices.innerHTML = '<img src="icons/tourist_office.png" alt="Office de Tourisme" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;"> Offices de Tourisme';
        L.DomEvent.on(buttonOffices, 'click', function () {
            toggleLayer(officesLayer, officesUrl, null, null, 'icons/tourist_office.png', function(url, layer) {
                addDataToLayer(url, layer, '#007bff', true);
            });
        });

        var buttonBikeRoutes = L.DomUtil.create('button', 'parcours-button', buttonContainer);
        buttonBikeRoutes.innerHTML = 'Parcours vélo';
        L.DomEvent.on(buttonBikeRoutes, 'click', function () {
            toggleLayer(bikeRoutesLayer, BikeRoutesUrl, null, null, 'icons/velo.png', function(url, layer) {
                addDataToLayer(url, layer, '#00FF00', false);
            });
        });

        var buttonBike = L.DomUtil.create('button', 'bike-button', container);
        buttonBike.innerHTML = 'Mobilité et Services';
        var submenu = L.DomUtil.create('div', 'submenu bike-submenu', container);

        var buttonBikeParking = L.DomUtil.create('button', '', submenu);
        buttonBikeParking.innerHTML = 'Parking à vélo';
        L.DomEvent.on(buttonBikeParking, 'click', function () {
            toggleLayer(bikeParkingLayer, bikeParkingUrl, bikeParkingIcon, 'bike_parking', 'icons/bicycle_parking.png', addGeoJsonLayer);
        });

        var buttonWaterPoints = L.DomUtil.create('button', '', submenu);
        buttonWaterPoints.innerHTML = 'Points d\'eau';
        L.DomEvent.on(buttonWaterPoints, 'click', function () {
            toggleLayer(waterPointsLayer, waterPointsUrl, waterPointIcon, 'water_point', 'icons/water_point.png', addGeoJsonLayer);
        });

        L.DomEvent.on(buttonBike, 'click', function () {
            submenu.style.display = submenu.style.display === 'none' || submenu.style.display === '' ? 'block' : 'none';
        });

        var buttonAccommodations = L.DomUtil.create('button', 'accommodations-button', container);
        buttonAccommodations.innerHTML = 'Hébergements Accueil vélo';
        var submenuAccommodations = L.DomUtil.create('div', 'submenu accommodations-submenu', container);

        var buttonHotels = L.DomUtil.create('button', '', submenuAccommodations);
        buttonHotels.innerHTML = 'Hôtels';
        L.DomEvent.on(buttonHotels, 'click', function () {
            toggleLayer(hotelsLayer, hotelsUrl, hotelIcon, 'hotel', 'icons/hotel.png', addGeoJsonLayer);
        });

        var buttonCampings = L.DomUtil.create('button', '', submenuAccommodations);
        buttonCampings.innerHTML = 'Campings';
        L.DomEvent.on(buttonCampings, 'click', function () {
            toggleLayer(campingsLayer, campingsUrl, campingIcon, 'camping', 'icons/camping.png', addGeoJsonLayer);
        });

        var buttonautresheb = L.DomUtil.create('button', '', submenuAccommodations);
        buttonautresheb.innerHTML = 'Autres hébergements';
        L.DomEvent.on(buttonautresheb, 'click', function () {
            toggleLayer(autreshebLayer, autreshebUrl, autreshebIcon, 'autresheb', 'icons/logo_acc_velo.png', addGeoJsonLayer);
        });

        var buttonCampingCar = L.DomUtil.create('button', '', submenuAccommodations);
        buttonCampingCar.innerHTML = 'Aires de camping-car';
        L.DomEvent.on(buttonCampingCar, 'click', function () {
            toggleLayer(campingCarLayer, campingCarUrl, campingCarIcon, 'camping_car', 'icons/camping-car.png', addGeoJsonLayer);
        });

        L.DomEvent.on(buttonAccommodations, 'click', function () {
            submenuAccommodations.style.display = submenuAccommodations.style.display === 'none' || submenuAccommodations.style.display === '' ? 'block' : 'none';
        });

        return container;
    }
});

map.addControl(new customControl());

// fonction pour afficher infoBox à la place de Info bulle
function showInfoBox(content) {
    var infoBox = document.getElementById('info-box');
    infoBox.innerHTML = content;
    infoBox.style.display = 'block';
}

// Fonction pour ajouter les icones selectionnées avec croix pour les supprimer
function toggleLayer(layer, url, icon, type, iconUrl, callback) {
    if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        removeSelectedIcon(iconUrl);
    } else {
        if (callback) {
            callback(url, layer, icon, type);
        }
        map.addLayer(layer);
        addSelectedIcon(iconUrl, layer);
    }
}

function addSelectedIcon(iconUrl, layer) {
    var selectedIconsContainer = document.getElementById('selected-icons');
    if (!selectedIconsContainer.querySelector(`img[src="${iconUrl}"]`)) {
        var img = document.createElement('img');
        img.src = iconUrl;
        img.style.width = '20px';
        img.style.height = '20px';
        img.style.margin = '5px';
        img.title = "Cliquez pour supprimer";
        img.onclick = function() {
            map.removeLayer(layer);
            selectedIconsContainer.removeChild(img);
        };
        selectedIconsContainer.appendChild(img);
    }
}

function removeSelectedIcon(iconUrl) {
    var selectedIconsContainer = document.getElementById('selected-icons');
    var iconImg = selectedIconsContainer.querySelector(`img[src="${iconUrl}"]`);
    if (iconImg) {
        selectedIconsContainer.removeChild(iconImg);
    }
}

// fonction pour ajouter les données à la carte
function addDataToLayer(url, layer, color, isOffice = false) {
    $.getJSON(url, function(data) {
        data.elements.forEach(function(element) {
            var popupContent = "";
            if (element.tags) {
                if (isOffice) {
                    popupContent += `<strong>${element.tags.name || "No name"}</strong><br><br>`;
                    if (element.tags.phone) popupContent += `Téléphone : ${element.tags.phone}<br>`;
                    if (element.tags.website) popupContent += `Site web : <a href="${element.tags.website}" target="_blank">${element.tags.website}</a><br>`;
                    if (element.tags.email) popupContent += `Email : <a href="mailto:${element.tags.email}">${element.tags.email}</a><br>`;
                    if (element.tags.opening_hours) popupContent += `Heures d'ouverture : ${translateOpeningHours(element.tags.opening_hours)}<br><br>`;
                    if (element.tags.description) popupContent += `<strong>Description :</strong> ${element.tags.description}<br>`;
                    popupContent += `(source OSM)`;
                } else {
                    popupContent += element.tags.name || "No name";
                }
            }

            // Bouton pour ajouter/enlever des favoris
            const favoriteButtonText = favorites.has(element.id) ? 'Retirer des favoris' : 'Ajouter aux favoris';
            popupContent += `<button id="favorite-btn-${element.id}" class="favorite-button">${favoriteButtonText}</button>`;

            if (element.type === "node") {
                var markerOptions = isOffice ? { icon: touristOfficeIcon } : { icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }) };
                var marker = L.marker([element.lat, element.lon], markerOptions);

                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e); // Empêche la propagation de l'événement click à la carte
                    showInfoBox(popupContent);

                    // Gestion du clic sur le bouton de favoris
                    const favoriteButton = document.getElementById(`favorite-btn-${element.id}`);
                    if (favoriteButton) {
                        favoriteButton.onclick = function() {
                            const newText = toggleFavorite(element.id, marker);
                            favoriteButton.innerText = newText;
                            updateFavoritesCounter(); // Mettre à jour le compteur de favoris
                        };
                    }
                });
                layer.addLayer(marker);
            } else if (element.type === "way") {
                var latlngs = element.geometry.map(function(geo) {
                    return [geo.lat, geo.lon];
                });
                var polygon = L.polygon(latlngs, { color: color });
                polygon.on('click', function() {
                    showInfoBox(popupContent);
                });
                layer.addLayer(polygon);

                // Calculer le centroïde du polygone
                var centroid = polygon.getBounds().getCenter();
                var markerOptions = isOffice ? { icon: touristOfficeIcon } : { icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }) };
                var marker = L.marker(centroid, markerOptions);
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e); // Empêche la propagation de l'événement click à la carte
                    showInfoBox(popupContent);
                });
                layer.addLayer(marker);
            }
        });
    });
}

// Appels aux fonctions pour charger les différentes couches
var map = L.map('map').setView([43.4683, -1.5566], 13);
var officesLayer = L.layerGroup().addTo(map);
var bikeRoutesLayer = L.layerGroup().addTo(map);
var bikeParkingLayer = L.layerGroup().addTo(map);
var waterPointsLayer = L.layerGroup().addTo(map);
var hotelsLayer = L.layerGroup().addTo(map);
var campingCarLayer = L.layerGroup().addTo(map);
var campingsLayer = L.layerGroup().addTo(map);
var autreshebLayer = L.layerGroup().addTo(map);

// Assure-toi que l'élément ID correspond à l'élément de la carte que tu utilises
addDataToLayer(officesUrl, officesLayer, '#007bff', true);
addDataToLayer(bikeRoutesUrl, bikeRoutesLayer, '#00FF00');
addDataToLayer(bikeParkingUrl, bikeParkingLayer, '#FF0000');
addDataToLayer(waterPointsUrl, waterPointsLayer, '#0000FF');
addDataToLayer(hotelsUrl, hotelsLayer, '#FFFF00');
addDataToLayer(campingCarUrl, campingCarLayer, '#FF00FF');
addDataToLayer(campingsUrl, campingsLayer, '#FFA500');
addDataToLayer(autreshebUrl, autreshebLayer, '#800080');

// Ici, tu peux ajouter la logique pour charger les fichiers KML si nécessaire
// addKMLFilesToMap(kmlFiles);
</script>
</body>
</html>
1
