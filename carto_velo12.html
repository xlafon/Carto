<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Carte avec Leaflet</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.5.1/gpx.min.js"></script>
   <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="map" style="width: 100%; height: 600px;"></div>
  <div id="info-box"></div>
  <div class="selected-icons" id="selected-icons"></div>
  <div id="favorites-box" class="favorites-box">
    <img src="icons/favorite.png" alt="Favoris" class="favorite-icon">
    <span id="favorites-count">0</span>
    <button id="view-favorites" class="view-favorites-button">Voir les favoris</button>
  </div>
  
  <script>
    var map = L.map('map').setView([43.492949, -1.474841], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var officesLayer = L.layerGroup().addTo(map);
    var bikeParkingLayer = L.layerGroup();
    var bikeRoutesLayer = L.layerGroup();
    var hotelsLayer = L.layerGroup();
    var campingsLayer = L.layerGroup();
    var currentGpxLayer = null;
    var currentMarker = null;

    var touristOfficeIcon = L.icon({
      iconUrl: 'icons/tourist_office.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
    var bikeParkingIcon = L.icon({
      iconUrl: 'icons/bicycle_parking.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
        var hotelIcon = L.icon({
      iconUrl: 'icons/logo_acc_velo.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
       var campingIcon = L.icon({
      iconUrl: 'icons/logo_acc_velo.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });
      var bikeIcon = L.icon({
      iconUrl: 'icons/velo.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    var favorites = [];

    function addToFavorites(item) {
  if (item.lat && item.lon && item.icon && item.popupContent) {
    if (!favorites.some(fav => fav.lat === item.lat && fav.lon === item.lon)) {
      favorites.push({
        lat: item.lat,
        lon: item.lon,
        icon: item.icon,
        popupContent: item.popupContent
      });
      updateFavoritesCount();
    }
  } else {
    console.error("Invalid item data:", item);
  }
}


    function removeFromFavorites(item) {
      var index = favorites.findIndex(fav => fav.lat === item.lat && fav.lon === item.lon);
      if (index > -1) {
        favorites.splice(index, 1);
        updateFavoritesCount();
      }
    }

    function updateFavoritesCount() {
      document.getElementById('favorites-count').innerText = favorites.length;
    }

    function isFavorite(item) {
      return favorites.some(fav => fav.lat === item.lat && fav.lon === item.lon);
    }

    function showInfoBox(content, item) {
  var infoBox = document.getElementById('info-box');
  infoBox.innerHTML = content;

  var favoriteButton = document.createElement('img');
  favoriteButton.className = 'favorite-button';
  if (isFavorite(item)) {
    favoriteButton.src = 'icons/removefav.png';
    favoriteButton.alt = 'Retirer des favoris';
    favoriteButton.onclick = function() {
      removeFromFavorites(item);
      showInfoBox(content, item); // Mettre à jour le bouton
    };
  } else {
    favoriteButton.src = 'icons/addfav.png';
    favoriteButton.alt = 'Ajouter aux favoris';
    favoriteButton.onclick = function() {
      addToFavorites(item);
      showInfoBox(content, item); // Mettre à jour le bouton
    };
  }

  infoBox.appendChild(favoriteButton);
  infoBox.style.display = 'block';
}


    function hideInfoBox() {
      var infoBox = document.getElementById('info-box');
      infoBox.style.display = 'none';
    }

    map.on('click', function() {
      hideInfoBox();
      if (currentGpxLayer) {
        map.removeLayer(currentGpxLayer);
        currentGpxLayer = null;
      }
    });

    function addDataToLayer(url, layer, color, isOffice = false) {
  $.getJSON(url, function(data) {
    data.elements.forEach(function(element) {
      var popupContent = "";
      if (element.tags) {
        if (isOffice) {
          popupContent += `<strong>${element.tags.name || "No name"}</strong><br><br>`;
          if (element.tags.phone) popupContent += `Téléphone : ${element.tags.phone}<br>`;
          if (element.tags.website) popupContent += `Site web : <a href="${element.tags.website}" target="_blank">${element.tags.website}</a><br>`;
          if (element.tags.email) popupContent += `Email : <a href="mailto:${element.tags.email}">${element.tags.email}</a><br>`;
          if (element.tags.opening_hours) popupContent += `Heures d'ouverture : ${translateOpeningHours(element.tags.opening_hours)}<br><br>`;
          if (element.tags.description) popupContent += `<strong>Description :</strong> ${element.tags.description}<br>`;
          popupContent += `(source OSM)`;
        } else {
          popupContent += element.tags.name || "No name";
        }
      }

      if (element.type === "node") {
        var markerOptions = isOffice ? { icon: touristOfficeIcon } : { icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }) };
        var marker = L.marker([element.lat, element.lon], markerOptions);
        marker.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          showInfoBox(popupContent, { lat: element.lat, lon: element.lon, icon: markerOptions.icon, popupContent });
        });
        layer.addLayer(marker);
      } else if (element.type === "way") {
        var latlngs = element.geometry.map(function(geo) {
          return [geo.lat, geo.lon];
        });
        var polygon = L.polygon(latlngs, { color: color });
        polygon.on('click', function() {
          showInfoBox(popupContent, { lat: latlngs, lon: latlngs, icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }), popupContent });
        });
        layer.addLayer(polygon);

        var centroid = polygon.getBounds().getCenter();
        var markerOptions = isOffice ? { icon: touristOfficeIcon } : { icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }) };
        var marker = L.marker(centroid, markerOptions);
        marker.on('click', function(e) {
          L.DomEvent.stopPropagation(e);
          showInfoBox(popupContent, { lat: centroid.lat, lon: centroid.lng, icon: markerOptions.icon, popupContent });
        });
        layer.addLayer(marker);
      }
    });
  });
}


    function addGeoJsonLayer(url, layer, icon, type) {
  $.getJSON(url, function(data) {
    L.geoJson(data, {
      pointToLayer: function (feature, latlng) {
        return L.marker(latlng, { icon: icon });
      },
      onEachFeature: function (feature, layer) {
        var popupContent = "";
        if (feature.properties) {
          if (type === 'bike_parking') {
            popupContent += `<strong>Parking à vélo</strong><br>`;
            if (feature.properties.capacity) popupContent += `Capacité : ${feature.properties.capacity} places<br>`;
            if (feature.properties.bicycle_parking) popupContent += `Type : ${mapBicycleParkingType(feature.properties.bicycle_parking)}<br>`;
            popupContent += `(source OSM)`;
          } else if (type === 'hotel') {
            if (feature.properties["Raison sociale"]) popupContent += `<span style="font-size: 14px;"><strong>${feature.properties["Raison sociale"]}</strong></span><br>`;
            if (feature.properties["Classement"]) popupContent += `<strong>${feature.properties["Classement"]}</strong><br>`;
            if (feature.properties["Lien première photo"]) popupContent += `<img src="${feature.properties["Lien première photo"]}" width="200px"><br>`;
            if (feature.properties["Capacité Nb logements"]) popupContent += `${feature.properties["Capacité Nb logements"]}<br>`;
            if (feature.properties["TEL"]) popupContent += `Tel.${feature.properties["TEL"]}<br>`;
            if (feature.properties.URL) popupContent += `Site web : <a href="${feature.properties.URL}" target="_blank">${feature.properties.URL}</a><br><br>`;
            if (feature.properties.Commune && feature.properties.Identifiant && feature.properties["Raison sociale"]) {
              var commune = feature.properties.Commune;
              var identifiant = feature.properties.Identifiant;
              var raisonSociale = formatRaisonSociale(feature.properties["Raison sociale"]);
              var moreInfoUrl = `https://www.tourisme64.com/hebergements/hotels/${commune}/${identifiant}-${raisonSociale}/`;
              popupContent += `<a href="${moreInfoUrl}" target="_blank" class="en-savoir-plus-button">En savoir plus</a>`;
            }
          } else if (type === 'camping') {
            if (feature.properties["Raison sociale"]) popupContent += `<span style="font-size: 14px;"><strong>${feature.properties["Raison sociale"]}</strong></span><br>`;
            if (feature.properties["Classement"]) popupContent += `<strong>${feature.properties["Classement"]}</strong><br>`;
            if (feature.properties["Lien première photo"]) popupContent += `<img src="${feature.properties["Lien première photo"]}" width="200px"><br>`;
            if (feature.properties["Capacité Nb logements"]) popupContent += `${feature.properties["Capacité Nb logements"]} emplacements<br>`;
            if (feature.properties["TEL"]) popupContent += `Tel.${feature.properties["TEL"]}<br>`;
            if (feature.properties.URL) popupContent += `Site web : <a href="${feature.properties.URL}" target="_blank">${feature.properties.URL}</a><br><br>`;
            if (feature.properties.Commune && feature.properties.Identifiant && feature.properties["Raison sociale"]) {
              var commune = feature.properties.Commune;
              var identifiant = feature.properties.Identifiant;
              var raisonSociale = formatRaisonSociale(feature.properties["Raison sociale"]);
              var moreInfoUrl = `https://www.tourisme64.com/hebergements/camping/${commune}/${identifiant}-${raisonSociale}/`;
              popupContent += `<a href="${moreInfoUrl}" target="_blank" class="en-savoir-plus-button">En savoir plus</a>`;
            }
          }
        }
        if (popupContent) {
          layer.on('click', function() {
            var item = { lat: feature.geometry.coordinates, lon: feature.geometry.coordinates, icon: icon, popupContent };
            if (item.lat && item.lon && item.icon && item.popupContent) {
              showInfoBox(popupContent, item);
            } else {
              console.error("Invalid item data:", item);
            }
          });
        }
      }
    }).addTo(layer);
  });
}

function showFavorites() {
  // Effacer toutes les couches de la carte
  map.eachLayer(function(layer) {
    if (layer instanceof L.TileLayer) return; // Ne pas supprimer la couche de tuiles de base
    map.removeLayer(layer);
  });

  // Ajouter les favoris à la carte
  favorites.forEach(function(item) {
    if (item.lat && item.lon && item.icon && item.popupContent) {
      var marker = L.marker([item.lat, item.lon], { icon: item.icon }).addTo(map);
      marker.bindPopup(item.popupContent);
    } else {
      console.error("Invalid favorite data:", item);
    }
  });

  // Ajouter le bouton "Quitter les favoris"
  var quitFavoritesButton = document.createElement('button');
  quitFavoritesButton.className = 'quit-favorites-button';
  quitFavoritesButton.innerText = 'Quitter les favoris';
  quitFavoritesButton.onclick = function() {
    // Réafficher toutes les couches initiales
    map.eachLayer(function(layer) {
      if (layer instanceof L.TileLayer) return; // Ne pas supprimer la couche de tuiles de base
      map.removeLayer(layer);
    });
    map.addLayer(officesLayer);
    map.addLayer(bikeParkingLayer);
       map.addLayer(hotelsLayer);
       map.addLayer(campingsLayer);
       document.getElementById('favorites-box').removeChild(quitFavoritesButton);
  };
  document.getElementById('favorites-box').appendChild(quitFavoritesButton);
}
    function addKmlLayer(url, layer) {
      omnivore.kml(url).addTo(layer);
    }

    function toggleLayer(layer, url, icon, type, iconUrl, callback) {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
        removeSelectedIcon(iconUrl);
      } else {
        if (callback) {
          callback(url, layer, icon, type);
        }
        map.addLayer(layer);
        addSelectedIcon(iconUrl, layer);
      }
    }

    function addSelectedIcon(iconUrl, layer) {
      var selectedIconsContainer = document.getElementById('selected-icons');
      if (!selectedIconsContainer) return;

      var iconWrapper = document.createElement('div');
      iconWrapper.style.position = 'relative';

      var img = document.createElement('img');
      img.src = iconUrl;
      img.dataset.layer = layer._leaflet_id;
      img.onclick = function() {
        map.removeLayer(layer);
        selectedIconsContainer.removeChild(iconWrapper);
      };

      var cross = document.createElement('div');
      cross.className = 'cross';
      cross.innerHTML = '✖';
      cross.onclick = function() {
        map.removeLayer(layer);
        selectedIconsContainer.removeChild(iconWrapper);
      };

      iconWrapper.appendChild(img);
      iconWrapper.appendChild(cross);
      selectedIconsContainer.appendChild(iconWrapper);
    }

    function removeSelectedIcon(iconUrl) {
      var selectedIconsContainer = document.getElementById('selected-icons');
      if (!selectedIconsContainer) return;

      var imgs = selectedIconsContainer.getElementsByTagName('img');
      Array.from(imgs).forEach(function(img) {
        if (img.src.includes(iconUrl)) {
          selectedIconsContainer.removeChild(img.parentElement);
        }
      });
    }

  


     var officesUrl = 'https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];area(id:3600007450)->.searchArea;nwr["information"="office"](area.searchArea);out geom;';
    var bikeParkingUrl = 'data/bike_parking.geojson';
      var hotelsUrl = 'data/HOT.geojson';
    var campingCarUrl = 'data/ACC.geojson';
    var campingsUrl = 'data/HPA.geojson';
        var BikeRoutesUrl = 'data/ITIVELO.geojson';

    var customControl = L.Control.extend({
      options: {
        position: 'topleft'
      },
      onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-control-custom');

        var header = L.DomUtil.create('div', 'header', container);

        var logo = L.DomUtil.create('img', '', header);
        logo.src = 'icons/LOGO_VISIT64.png';
        
        var title = L.DomUtil.create('h2', '', header);
        title.innerHTML = 'Carte vélo 64';

        var buttonContainer = L.DomUtil.create('div', 'button-container', container);

        var buttonOffices = L.DomUtil.create('button', 'offices-button', container);
        buttonOffices.innerHTML = '<img src="icons/tourist_office.png" alt="Office de Tourisme" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 5px;"> Offices de Tourisme';
        L.DomEvent.on(buttonOffices, 'click', function () {
          toggleLayer(officesLayer, officesUrl, null, null, 'icons/tourist_office.png', function(url, layer) {
            addDataToLayer(url, layer, '#007bff', true);
          });
        });

        var buttonBikeRoutes = L.DomUtil.create('button', 'parcours-button', buttonContainer);
        buttonBikeRoutes.innerHTML = 'Parcours vélo';
        L.DomEvent.on(buttonBikeRoutes, 'click', function () {
          toggleLayer(bikeRoutesLayer, 'data/ITIVELO.geojson', null, null, 'icons/velo.png', function(url, layer) {
            addBikeRoutesLayer(url, layer);
          });
        });

                var buttonBike = L.DomUtil.create('button', 'bike-button', container);
        buttonBike.innerHTML = 'Mobilité et Services';
        var submenu = L.DomUtil.create('div', 'submenu bike-submenu', container);

        var buttonBikeParking = L.DomUtil.create('button', '', submenu);
        buttonBikeParking.innerHTML = 'Parking à vélo';
        L.DomEvent.on(buttonBikeParking, 'click', function () {
          toggleLayer(bikeParkingLayer, bikeParkingUrl, bikeParkingIcon, 'bike_parking', 'icons/bicycle_parking.png', addGeoJsonLayer);
        });

       

        L.DomEvent.on(buttonBike, 'click', function () {
          if (submenu.style.display === 'none' || submenu.style.display === '') {
            submenu.style.display = 'block';
          } else {
            submenu.style.display = 'none';
          }
        });

        var buttonAccommodations = L.DomUtil.create('button', 'accommodations-button', container);
        buttonAccommodations.innerHTML = 'Hébergements Accueil vélo';
        var submenuAccommodations = L.DomUtil.create('div', 'submenu accommodations-submenu', container);

        var buttonHotels = L.DomUtil.create('button', '', submenuAccommodations);
        buttonHotels.innerHTML = 'Hôtels';
        L.DomEvent.on(buttonHotels, 'click', function () {
          toggleLayer(hotelsLayer, hotelsUrl, hotelIcon, 'hotel', 'icons/hotel.png', addGeoJsonLayer);
        });

        var buttonCampings = L.DomUtil.create('button', '', submenuAccommodations);
        buttonCampings.innerHTML = 'Campings';
        L.DomEvent.on(buttonCampings, 'click', function () {
          toggleLayer(campingsLayer, campingsUrl, campingIcon, 'camping', 'icons/camping.png', addGeoJsonLayer);
        });

       
        L.DomEvent.on(buttonAccommodations, 'click', function () {
          if (submenuAccommodations.style.display === 'none' || submenuAccommodations.style.display === '') {
            submenuAccommodations.style.display = 'block';
          } else {
            submenuAccommodations.style.display = 'none';
          }
        });

        return container;
      }
    });

    map.addControl(new customControl());

    document.getElementById('view-favorites').addEventListener('click', function() {
      showFavorites();
    });
function translateOpeningHours(openingHours) {
      return openingHours.replace(/Mo/g, 'Lun')
                                 .replace(/Dec/g, 'Déc');
    }

    function mapBicycleParkingType(type) {
      var mapping = {
                'shed': 'abri vélo'
      };
      return mapping[type] || type;
    }

    function formatRaisonSociale(raisonSociale) {
      return raisonSociale.replace(/\s+/g, '-');
    }
    
  </script>
</body>
</html>
1
