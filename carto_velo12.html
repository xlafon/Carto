<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carte vélo 64</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; }
        .leaflet-control-custom { background: white; padding: 10px; }
        .button-container { display: flex; flex-direction: column; }
        .submenu { display: none; }
        #info-box { background: white; padding: 10px; position: absolute; z-index: 9999; display: none; }
        #selected-icons { position: absolute; top: 10px; right: 10px; }
        #favorites-counter { font-weight: bold; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="info-box"></div>
<div id="selected-icons"></div>
<div>Favoris: <span id="favorites-counter">0</span></div>

<script>
var map = L.map('map').setView([43.4683, -1.5566], 13);

// Ajouter un fond de carte
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '© OpenStreetMap'
}).addTo(map);

// URLs des données
var officesUrl = 'https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];area(id:3600007450)->.searchArea;nwr["information"="office"](area.searchArea);out geom;';
var bikeParkingUrl = 'data/bike_parking.geojson';
var waterPointsUrl = 'data/water_points.geojson';
var hotelsUrl = 'data/HOT.geojson';
var campingCarUrl = 'data/ACC.geojson';
var campingsUrl = 'data/HPA.geojson';
var autreshebUrl = 'data/AUTRESHEEB.geojson';
var BikeRoutesUrl = 'data/ITIVELO.geojson';

var favorites = new Set(); // Utiliser un Set pour stocker les favoris
var favoriteLayer = L.layerGroup().addTo(map); // Calque pour les favoris

function updateFavoritesCounter() {
    var counter = document.getElementById('favorites-counter');
    if (counter) {
        counter.innerText = favorites.size; // Mettre à jour le compteur
    }
}

function toggleFavorite(elementId, marker) {
    if (favorites.has(elementId)) {
        favorites.delete(elementId); // Retirer des favoris
        favoriteLayer.removeLayer(marker); // Retirer le marqueur des favoris
        return 'Ajouter aux favoris';
    } else {
        favorites.add(elementId); // Ajouter aux favoris
        favoriteLayer.addLayer(marker); // Ajouter le marqueur aux favoris
        return 'Retirer des favoris';
    }
}

var customControl = L.Control.extend({
    options: {
        position: 'topleft'
    },
    onAdd: function (map) {
        var container = L.DomUtil.create('div', 'leaflet-control-custom');

        var header = L.DomUtil.create('div', 'header', container);
        var title = L.DomUtil.create('h2', '', header);
        title.innerHTML = 'Carte vélo 64';

        var buttonContainer = L.DomUtil.create('div', 'button-container', container);

        var buttonOffices = L.DomUtil.create('button', 'offices-button', container);
        buttonOffices.innerHTML = 'Offices de Tourisme';
        L.DomEvent.on(buttonOffices, 'click', function () {
            addDataToLayer(officesUrl, true, '#007bff');
        });

        var buttonBikeRoutes = L.DomUtil.create('button', 'parcours-button', buttonContainer);
        buttonBikeRoutes.innerHTML = 'Parcours vélo';
        L.DomEvent.on(buttonBikeRoutes, 'click', function () {
            addDataToLayer(BikeRoutesUrl, false, '#00FF00');
        });

        var buttonBike = L.DomUtil.create('button', 'bike-button', container);
        buttonBike.innerHTML = 'Mobilité et Services';
        var submenu = L.DomUtil.create('div', 'submenu bike-submenu', container);

        var buttonBikeParking = L.DomUtil.create('button', '', submenu);
        buttonBikeParking.innerHTML = 'Parking à vélo';
        L.DomEvent.on(buttonBikeParking, 'click', function () {
            addDataToLayer(bikeParkingUrl, false, '#FF0000');
        });

        var buttonWaterPoints = L.DomUtil.create('button', '', submenu);
        buttonWaterPoints.innerHTML = 'Points d\'eau';
        L.DomEvent.on(buttonWaterPoints, 'click', function () {
            addDataToLayer(waterPointsUrl, false, '#0000FF');
        });

        L.DomEvent.on(buttonBike, 'click', function () {
            submenu.style.display = submenu.style.display === 'none' || submenu.style.display === '' ? 'block' : 'none';
        });

        var buttonAccommodations = L.DomUtil.create('button', 'accommodations-button', container);
        buttonAccommodations.innerHTML = 'Hébergements Accueil vélo';
        var submenuAccommodations = L.DomUtil.create('div', 'submenu accommodations-submenu', container);

        var buttonHotels = L.DomUtil.create('button', '', submenuAccommodations);
        buttonHotels.innerHTML = 'Hôtels';
        L.DomEvent.on(buttonHotels, 'click', function () {
            addDataToLayer(hotelsUrl, false, '#FFFF00');
        });

        var buttonCampings = L.DomUtil.create('button', '', submenuAccommodations);
        buttonCampings.innerHTML = 'Campings';
        L.DomEvent.on(buttonCampings, 'click', function () {
            addDataToLayer(campingsUrl, false, '#FFA500');
        });

        var buttonCampingCar = L.DomUtil.create('button', '', submenuAccommodations);
        buttonCampingCar.innerHTML = 'Aires de camping-car';
        L.DomEvent.on(buttonCampingCar, 'click', function () {
            addDataToLayer(campingCarUrl, false, '#FF00FF');
        });

        L.DomEvent.on(buttonAccommodations, 'click', function () {
            submenuAccommodations.style.display = submenuAccommodations.style.display === 'none' || submenuAccommodations.style.display === '' ? 'block' : 'none';
        });

        return container;
    }
});

map.addControl(new customControl());

// fonction pour afficher infoBox
function showInfoBox(content) {
    var infoBox = document.getElementById('info-box');
    infoBox.innerHTML = content;
    infoBox.style.display = 'block';
}

// fonction pour ajouter les données à la carte
function addDataToLayer(url, isOffice, color) {
    $.getJSON(url, function(data) {
        var layerGroup = L.layerGroup().addTo(map);
        data.elements.forEach(function(element) {
            var popupContent = "";
            if (element.tags) {
                if (isOffice) {
                    popupContent += `<strong>${element.tags.name || "No name"}</strong><br><br>`;
                    if (element.tags.phone) popupContent += `Téléphone : ${element.tags.phone}<br>`;
                    if (element.tags.website) popupContent += `Site web : <a href="${element.tags.website}" target="_blank">${element.tags.website}</a><br>`;
                    if (element.tags.email) popupContent += `Email : <a href="mailto:${element.tags.email}">${element.tags.email}</a><br>`;
                    if (element.tags.opening_hours) popupContent += `Heures d'ouverture : ${element.tags.opening_hours}<br><br>`;
                    if (element.tags.description) popupContent += `<strong>Description :</strong> ${element.tags.description}<br>`;
                } else {
                    popupContent += `<strong>${element.tags.name || "No name"}</strong><br>`;
                }
            }

            // Bouton pour ajouter/enlever des favoris
            const favoriteButtonText = favorites.has(element.id) ? 'Retirer des favoris' : 'Ajouter aux favoris';
            popupContent += `<button id="favorite-btn-${element.id}" class="favorite-button">${favoriteButtonText}</button>`;

            if (element.type === "node") {
                var markerOptions = isOffice ? { icon: L.icon({ iconUrl: 'icons/tourist_office.png' }) } : { icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }) };
                var marker = L.marker([element.lat, element.lon], markerOptions);

                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e); // Empêche la propagation de l'événement click à la carte
                    showInfoBox(popupContent);

                    // Gestion du clic sur le bouton de favoris
                    const favoriteButton = document.getElementById(`favorite-btn-${element.id}`);
                    if (favoriteButton) {
                        favoriteButton.onclick = function() {
                            const newText = toggleFavorite(element.id, marker);
                            favoriteButton.innerText = newText;
                            updateFavoritesCounter(); // Mettre à jour le compteur de favoris
                        };
                    }
                });
                layerGroup.addLayer(marker);
            } else if (element.type === "way") {
                var latlngs = element.geometry.map(function(geo) {
                    return [geo.lat, geo.lon];
                });
                var polygon = L.polygon(latlngs, { color: color });
                polygon.on('click', function() {
                    showInfoBox(popupContent);
                });
                layerGroup.addLayer(polygon);

                // Calculer le centroïde du polygone
                var centroid = polygon.getBounds().getCenter();
                var markerOptions = isOffice ? { icon: L.icon({ iconUrl: 'icons/tourist_office.png' }) } : { icon: L.divIcon({ className: 'custom-icon', html: `<div style="background-color: ${color}; width: 12px; height: 12px; border-radius: 50%;"></div>` }) };
                var marker = L.marker(centroid, markerOptions);
                marker.on('click', function(e) {
                    L.DomEvent.stopPropagation(e); // Empêche la propagation de l'événement click à la carte
                    showInfoBox(popupContent);
                });
                layerGroup.addLayer(marker);
            }
        });
    });
}

// Appels aux fonctions pour charger les différentes couches
addDataToLayer(officesUrl, true, '#007bff');
addDataToLayer(bikeParkingUrl, false, '#FF0000');
addDataToLayer(waterPointsUrl, false, '#0000FF');
addDataToLayer(hotelsUrl, false, '#FFFF00');
addDataToLayer(campingCarUrl, false, '#FF00FF');
addDataToLayer(campingsUrl, false, '#FFA500');
addDataToLayer(autreshebUrl, false, '#800080');
addDataToLayer(BikeRoutesUrl, false, '#00FF00');

</script>
</body>
</html>
2
